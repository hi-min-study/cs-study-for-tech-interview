# 25_동기화_교착상태

- 프로세스 동기화
    - 공유자원, 경쟁상태, 임계구역
    - 피터슨 알고리즘
    - 뮤텍스
    - 세마포어
    - 모니터
- 교착 상태(Deadlock)
    - 교착 상태 정의
    - 교착 상태 조건
    - 교착 상태 해결 방법
    - 식사하는 철학자 문제
    

# 면접 질문

### 임계 영역(Critical Section)에 대해 설명해주세요.

임계 영역이란 프로세스간에 공유자원을 접근하는데 있어 문제가 발생하지 않도록 한번에 하나의 프로세스만 이용하게끔 보장해줘야 하는 영역을 말합니다.

임계 영역 문제를 해결하기 위해서는 아래의 3가지 조건을 충족해야 합니다.

1. 상호 배제(Mutual exclution) - 하나의 프로세스가 임계 영역에 들어가 있다면 다른 프로세스는 들어갈 수 없어야 한다.
2. 진행(Progress) - 임계 영역에 들어간 프로세스가 없는 상태에서 들어가려 하는 프로세스가 여러 개라면 어느 것이 들어갈지 결정 해주어야 한다.
3. 한정 대기(Bounded waiting) - 다른 프로세스의 기아를 방지하기 위해, 한 번 임계 구역에 들어간 프로세스는 다음 번 임계 영역에 들어갈 때 제한을 두어야 한다.

### 세마포어(Semaphore) 란?

세마포어는 리소스의 상태를 나타내는 간단한 카운터로 생각할 수 있다. 일반적으로 비교적 긴 시간을 확보하는 리소스에 대해 이용하게 되며, 유닉스 시스템의 프로그래밍에서 세마포어는 운영체제의 리소스를 경쟁적으로 사용하는 다중 프로세스에서 행동을 조정하거나 또는 동기화 시키는 기술이다.

현재 공유자원에 접근할 수 있는 쓰레드,프로세스의 수를 나타내는 값을 두어 상호배제를 달성하는 기법이다.

### 뮤텍스(Mutex) 란?

상호배제라고도 한다. 임계 영역을 가진 쓰레드들의 Running Time이 서로 겹치지 않게 각각 단독으로 실행하게 하는 기술이다. 다중 프로세스들의 공유 리소스에 대한 접근을 조율하기 위해 locking과 unlocking을 사용한다.

즉, 쉽게 말하면 뮤텍스 객체를 두 쓰레드가 동시에 이용할 수 없다는 의미이다.

### 뮤텍스(Mutex)와 세마포어(Semaphore)의 차이에 대해 설명해주세요.

1. 세마포어는 뮤텍스가 될 수 있지만 뮤텍스는 세마포어가 될 수 없다.
2. 세마포어는 소유할 수 없는 반면, 뮤텍스는 소유가 가능하며 소유주가 이에 대한 책임을 진다.
3. 뮤텍스의 경우 뮤텍스를 소유하고 있는 쓰레드가 이 뮤텍스를 해제할 수 있다. 하지만 세마포어의 경우 이러한 세마포어를 소유하지 않는 쓰레드가 세마포어를 해제할 수 있다.
4. 세마포어는 시스템 범위에 걸쳐있고 파일시스템상의 파일 형태로 존재한다. 반면 뮤텍스는 프로세스 범위를 가지며 프로세스가 종료될 때 자동으로 Clean up 된다.

가장 큰 차이점은 관리하는 **동기화 대상의 갯수**이다.

**뮤텍스는 동기화 대상이 오직 하나뿐일 때, 세마포어는 동기화 대상이 하나 이상일 때 사용한다.**

예시를 들면

뮤텍스는 화장실이 하나 뿐인 없는 식당과 비슷하고 화장실을 가기 위해서는 카운터에서 열쇠를 받아 가야한다.

세마포어는 여러 개의 화장실 칸을 가진 레스토랑이다. 화장실 입구에는 현재 화장실의 빈 칸 개수를 보여주는 전광판이 있다. 전광판에 빈 칸이 1개 이상이면 사용이 가능하고 0개이면 대기해야된다.

### Monitor란?

하나의 프로세스 내의 다른 스레드 간 동기화에 사용되는 기술입니다. 뮤텍스의 상위호환 개념으로, 사용자가 프로세스에 lock을 거는 등 동기화 제약 조건을 명시적으로 코딩할 필요가 없다는게 특징입니다.

(뮤텍스는 다른 프로세스간에 동기화할떄 사용)

### 피터슨 알고리즘이란 무엇인가요 ?

**두 개 이상의 프로세스의 동기화(Synchronization) 문제**를 해결하는 방법 입니다.

Peterson's Solution은 critical section problem을 해결 하기 위한 세 가지 조건인

**mutual exclusion**    **progress**   **bounded waiting** 을 모두 충족 합니다.

●**Mutual exclusion**

**flag , turn 두 변수를 통해 충족**

**●progress**

**프로세스가 critical section을 나오자마자 flag 변수를 false로 설정함으로써**

**critical section 입장을 기다리던 프로세스가 바로 진입할 수 있도록 도와 주기 때문에 progress 또한 충족**

**●Bounded waiting**

**두 개의 프로세스이기 때문에 충족**

### **교착상태(Dead Lock)란 무엇인가?**

교착 상태는 자원을 여러 곳에서 사용하려고 할 때 발생하는 문제이다.

서로 원하는 자원이 상대방에게 할당되어 있어 두 프러세스가 무한정 wait 상태에 빠지게 되는 상황.

https://oopy.lazyrockets.com/api/v2/notion/image?src=https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe5ed69aa-e453-4bdc-89a8-7e9ad320a475%2F_2021-05-02__4.17.26.png&blockId=bc085567-f7ec-4dd9-8f53-2dd629c631bd

### **교착상태가 발생하기 위한 조건은 무엇인가요?**

4가지 조건을 모두 만족해야 데드락이 발생한다.

1. **상호 배제(Mutual exclusion) :** 자원은 한번에 한 프로세스만 사용할 수 있음
2. **점유 대기(Hold and wait) :** 최소한 하나의 자원을 점유하고 있으면서 다른 프로세스에 할당되어 사용하고 있는 자원을 추가로 점유하기 위해 대기하는 프로세스가 존재해야 함
3. **비선점(No preemption) :** 다른 프로세스에 할당된 자원은 사용이 끝날 때까지 강제로 빼앗을 수 없음
4. **순환 대기(Circular wait) :** 프로세스의 집합에서 순환 형태로 자원을 대기하고 있어야 함

### **교착상태의 해결법은 무엇인가요?**

1.**예방(prevention)**

교착 상태 발생 조건 중 하나를 제거하면서 해결한다 (자원 낭비 엄청 심함)

- 상호배제 부정 : 여러 프로세스가 공유 자원 사용
- 점유대기 부정 : 프로세스 실행전 모든 자원을 할당
- 비선점 부정 : 자원 점유 중인 프로세스가 다른 자원을 요구할 때 가진 자원 반납
- 순환대기 부정 : 자원에 고유번호 할당 후 순서대로 자원 요구
1. **회피(avoidance) -** 교착 상태 발생 시 피해나가는 방법

은행원 알고리즘(Banker's Algorithm)

은행에서 모든 고객의 요구가 충족되도록 현금을 할당하는데서 유래함

프로세스가 자원을 요구할 때, 시스템은 자원을 할당한 후에도 안정 상태로 남아있으면 자원할당, 아니면 할당을 거부하고 다른 프로세스 들이 자원을 해지할때까지 대기하는 방법

1. **탐지(Detection) & 회복**

은행원 알고리즘과 유사한 방식 vs 자원 할당 그래프를 통해 교착 상태를 탐지함

자원 요청 시, 탐지 알고리즘을 실행시켜 그에 대한 오버헤드 발생함

1. **회복(Recovery) -** 교착 상태 일으킨 프로세스를 종료하거나, 할당된 자원을 해제시켜 회복시키는 방법

**프로세스 종료 방법**

- 교착 상태의 프로세스를 모두 중지
- 교착 상태가 제거될 때까지 하나씩 프로세스 중지

**자원 선점 방법**

- 교착 상태의 프로세스가 점유하고 있는 자원을 선점해 다른 프로세스에게 할당 (해당 프로세스 일시정지 시킴)
- 우선 순위가 낮은 프로세스나 수행 횟수 적은 프로세스 위주로 프로세스 자원 선점

### **회피 기법인 은행원 알고리즘이 뭔지 설명해보세요.**

은행원 알고리즘은 은행에서 현금을 할당하는 것에서 유래한 알고리즘입니다.

프로세스가 자원을 요구할때 자원을 할당한 후에도 안정 상태이면 자원을 할당하고, 그렇지 않으면 다른 자원이 해제될때까지 대기했다가 자원을 할당합니다.

### 식사하는 철학자(Dining Philosophers) 문제에 대해서 설명해주세요.

5명의 철학자가 원탁에 앉아 있고 각자의 앞에는 스파게티가 있다. 그리고 양 옆에 포크가 하나씩 있다. 각각의 철학자는스파게티를 먹으려면 포크를 2개 사용해야하며,다른 철학자에게 말을 걸 수 없고 포크를 빼앗을 수 없다는 조건이 있다.

교착상태를 설명하는 대표적인 문제이다 이 상황에서 철학자들이 동시에 오른쪽 포크를 집어든다면? (철학자들이 프로세스, 포크가 자원이라고 생각하면 편하다.) 철학자들은 포크를 공유할 수 없고(상호 배제), 자신의 왼쪽에 앉은 철학자가 포크를 놓을 때까지 기다린다.(점유 상태로 대기) 철학자들은 왼쪽 철학자의 포크를 빼앗을 방법도 없으며,(선점 불가) 각 철학자들은 자신의 왼쪽 철학자의 포크를 대기한다.(순환대기) 

https://t1.daumcdn.net/cfile/tistory/253CDD4B5802FBB52A

### 식사하는 철학자 문제를 해결하는 방법은 무엇인가요  ?

이러한 교착 상태를 회피하려면 발생조건 4가지 중 한가지만 해제하면 됩니다. 상호 배제와 선점 불가의 경우, 문제의 조건 때문에 해소가 불가능합니다. '점유 상태로 대기'를 해제하려면 왼쪽 포크를 집을 수 없을 때, 오른쪽 포크를 식탁 위에 내려놓는 방법이 있습니다. '순환 대기'를 해소하려면포크에 우선 순위를 매기는 방법이 있습니다.

# Ref

https://yoonah-dev.oopy.io/5a379ce1-a33f-42b4-a513-66e0ce508040

https://preamtree.tistory.com/18

https://jokerkwu.tistory.com/126

https://dev-coco.tistory.com/162

https://8156217.tistory.com/40
