# Spring_JPA_Test

- JPA
    - 프록시
    - 고아객체
    - 단뱡향/양방향 매핑
    - N + 1 문제
- 테스트
    - DDD, TDD
    - Junit4 vs Junit5
    - 단위, 통합, 인수 테스트
    - stub, mock
    - SpringBoot 계층별 테스트 방법
    - 테스트 커버리지 (JACOCO)
    
    ### JPA에서 Proxy란 무엇인가요?
    
    **프록시는 실제 엔티티 객체 대신 데이터베이스 조회를 지연할 수 있는 가짜 객체**를 의미합니다.
    
    1. 왜 사용하나요 ? 
        
        자유로운 객체 그래프 탐색의 가능성으로 인해 연관된 모든 테이블을 조회하는 것은 비용이 따릅니다. 연관된 객체를 처음부터 데이터베이스에서 조회하는 것이 아니라, 실제 사용하는 시점에 데이터베이스에서 조회할 수 있도록 해줍니다.
        
    ### Hibernate에서 Proxy는 어떻게 생성되고 사용되나요?
    1. getReference 호출을 통해 프록시 객체를 생성합니다. 해당 프록시 객체의 정보가 영속성 컨텍스트에 1차 캐시로 존재한다면 프록시 객체가 아닌 실제 객체를 반환합니다. 아직 사용이 존재하지 않기에 실제 엔티티 객체의 참조를 가지고 있지 않습니다.
    2. 실제 사용을 위해 메서드를 호출합니다.
    3. 메서드가 호출되면 영속성 컨텍스트에 초기화를 요청합니다. 실제 엔티티 객체의 참조를 가지기 위해 실제 엔티티 객체의 생성이 필요합니다.
    4. 영속성 컨텍스트는 데이터베이스를 조회해서 실제 엔티티 객체의 정보를 얻습니다.
    5. 조회된 정보를 바탕으로 실제 Entity 객체를 생성합니다.
    6. 참조를 통해 실제 엔티티 객체의 메서드를 호출합니다.
    7. 메서드 호출의 결과를 반환합니다.
    
    ### JPA에서의 단방향/ 양방향 연관관계에 대해 설명해주세요.
    
    - 단방향 : 객체 관계에서 한쪽만 참조하는 것을 말합니다.
    - 양방향 : 객체 관계에서 양쪽이 서로 참조하는 것을 말합니다.
    
    ### 연관관계 주인이란 무엇인가요 ?
    
    연관관계 주인은 두 객체의 연관관계 중 하나를 정해서 데이터베이스의 외래키를 관리하는 것입니다.
    
    ### 연관관계 주인은 어떻게 정하나요 ?
    
    - 1 : N or N : 1 일 경우 : N이 연관관계 주인
    - 1 : 1 일 경우 : 주테이블이 연관관계 주인
    - M : N 일경우 : M과 N을 연결해주는 테이블 추가하여 1 : M과 N : 1을 만들어서 M과 N이 연관관계 주인
    
    ### 연관관계주인과 주인이 아닌것은 코드 상으로 어떻게 설정할 수 있나요 ?
    
    연관관계 주인은 @JoinColumn(name = "참조하는 테이블 기본키")
    
    연관관계 주인이 아닌 것은 mappedBy = "연관관계 주인에서 정의한 변수"
    
    ### N+1 문제란 무엇인가요 ?
    
    연관 관계가 설정된 엔티티를 조회할 경우에 조회된 데이터 갯수(n) 만큼 연관관계의 조회 쿼리가 추가로 발생하여 데이터를 읽어오는 현상입니다.
    
    ### **왜 N+1 문제가 발생하나요 ?**
    
    JPA Repository로 find 시 실행하는 첫 쿼리에서 하위 엔티티까지 한 번에 가져오지 않고, 하위 엔티티를 사용할 때 추가로 조회하기 때문입니다. 
    
    ### **N+1 문제를 어떻게 해결하나요 ?**
    
    **Fetch Join**
    
    JPQL을 사용하여 DB에서 데이터를 가져올 때 처음부터 연관된 데이터까지 같이 가져오게 하는 방법입니다. (SQL Join 문을 생각하면 됩니다. )
    
    별도의 메소드를 만들어줘야 하며 @Query 어노테이션을 사용해서 "join fetch 엔티티.연관관계_엔티티" 구문을 만들어 주면 됩니다.
    
    ```java
    public interface TeamRepository extends JpaRepository<Team, Long> {
        @Query("select t from Team t join fetch t.users")
        List<Team> findAllFetchJoin();
    }
    ```
    
    ### 영속성 전이(CASCADE) 란 무엇인가요 ?
    
    특정 엔티티를 영속 상태로 만들 때 연관된 엔티티도 함께 영속 상태로 만들고 싶을 때 사용하는 옵션
    
    ### 고아객체란 무엇이고 사용시의 주의점에 대해서 설명해주세요.
    
    고아 객체란 부모 엔티티와 연관관계가 끊어진 자식 엔티티를 말합니다.
    참조하는 곳이 하나일때 사용해야 하며, 
    **특정 엔티티가 개인 소유할 때 사용하고,**
    
    **@OneToOne, @OneToMany만 가능합니다.**
    
    개념적으로 부모를 제거하면 자식은 고아가 된다.따라서 고아 객체 제거 기능을 활성화 하면, 부모를 제거할 때 자식도 함께 제거된다.이것은 CascadeType.REMOVE처럼 동작합니다.
    
    ### DDD와 TDD에 대해서 설명해주세요.
    
     
    TDD : **테스트** 주도 개발. 코드를 작성하기 전에 테스트(Test)를 먼저 작성해야 합니다.
    TDD는 매우 짧은 개발 서클의 반복에 의존하는 소프트웨어 개발 프로세스입니다.
    
    우선 개발자는 요구되는 새로운 기능에 대한 자동화된 테스트 케이스를 작성하고, 해당 케스트를 통과하는 가장 짧고 가독성이 좋고 유지보수성이 뛰어난 코드를 작성합니다. 일단 테스트 통과하는 코드를 작성하고 상황에 맞게 리팩토링하는 과정을 거칩니다.
    
    DDD : **도메인** 주도 개발. DDD는 도메인 그 자체와 도메인 로직에 초점을 맞춥니. 일반적으로 많이 사용하는 데이터 중심의 접근법을 탈피하여 순수한 도메인의 모델과 로직에 집중하는 것을 말합니다.
    
    ### **junit4, 5각각의 장단점에 대해서 설명해주세요.**
    
    JUnit4의 장단점
    
    - **장점**
    - JUnit4는 안정적이고 성숙한 프레임워크입니다.
    - 풍부한 기능을 지원하며 대부분의 Java 개발자들이 익숙합니다.
    - 또한 다양한 IDE에서 지원되어 사용이 편리합니다.
    
    - **단점**
    - JUnit4는
        
        확장성이 떨어지고 테스트 코드의 구성이 어려울 수 있습니다.
        
    - 또한 멀티스레드 테스트 지원이 불안정하다는 문제점이 있습니다.
    
    JUnit5의 장단점
    
    - **장점**
    - JUnit5는 JUnit4의 했습니다.
        
        문제점을 보완하고 새로운 기능을 추가
        
    - 테스트 인스턴스 라이프사이클을 지원하고, 동적 테스트를 지원하며, 테스트 파라미터화 기능도 추가되었습니다.
    - 또한 모듈화가 가능하여 필요한 모듈만 사용할 수 있습니다.
    
    - **단점**
    - JUnit5는 아직 많은 . 또한 IDE 지원이 JUnit4에 비해 미흡한 경우도 있습니다.
        
        Java 개발자들이 익숙하지 않습니다
        
    - JUnit5가 JUnit4에 비해 많은 새로운 기능을 제공하므로 최근에는 더 많이 사용되고 있습니다.
    - 그러나 일부 프로젝트에서는 아직 JUnit4를 계속 사용하고 있습니다.
    
    ### 단위, 통합, 인수 테스트에 대해서 설명해주세요.
    
    단위 테스트는 개별 코드 유닛을 테스트하고, 통합 테스트는 코드 유닛 간의 상호 작용을 테스트합니다. 인수 테스트는 최종 사용자의 요구 사항을 확인하고 소프트웨어를 수용 또는 거부하는 역할을 합니다.
    
    ### Stub과 Mock에 대해 설명해주세요.
    
    Stub - 테스트중 생기는 호출에 미리 준비된 결과를 반환합니다. 테스트 외에는 응답하지 않습니다.
    테스트의 동작과 테스트의 상태 검증을 위한것입니다.
    
    Mock - 호출될 것으로 기대되는 값으로 미리 만들어진 객체입니다.
    
    stub과 다르게 mock객체는 **행동**에 대한 검증을 합니다.
    
    ### SpringBoot 계층별 테스트 방법에 대해서 설명해주세요.
    
    Repository : JPA를 테스트하기 위해서 @DataJpaTest 어노테이션을 사용합니다. @DataJpaTest 어노테이션은 JPA 관련 테스트 설정만 로드하며, 실제 데이터베이스가 아닌 내장 데이터베이스를 사용한다는 특징이 있습니다.
    
    Service : Service 계층에는 비즈니스 로직들이 담겨있습니다. 이 비즈니스 로직들이 잘 동작하는지 테스트해야합니다. 하지만 의존성이 있는 객체들이 잘 동작하는지는 이 영역에서는 관심 밖입니다. 그래서 의존 객체들을 Mockito 프레임워크를 활용해 Mocking하여 테스트를 진행합니다.
    Controller : Controller를 테스트하기 위해서는 Mock이라는 가상의 객체를 만들어 접속을 테스트하는 방식으로 진행됩니다. Mock을 제어하기 위한 @AutoConfigureMockMvc 어노테이션을 설정하고 테스트를 위해 @SpringBootTest 어노테이션도 추가했습니다. 코드 내부에서는 MockMvc 객체를 @Autowired하여 의존성 주입 후 @Test 어노테이션을 통해 테스트를 수행합니다. 이 때 perform() 메소드를 통해 입력받을 URI를 설정하고, 실행 결과에 대해서도 확인할 수 있도록 옵션을 추가합니다.
    
    ### code coverage란 무엇인가요 ?
    
    Code Coverage란 소프트웨어에서 test code가 본 코드를 얼마나 커버하고 있냐를 측정해주는 지표입니다.
    
    ### Jacoco 란 무엇인가요 ?
    
    JaCoCo란 Java Code의 coverage를 측정하는 라이브러리입니다. 테스트를 실행하고, 그 결과를 html 파일이나 csv, xml 파일을 통해서 시각화해줍니다. 또한, 결과에 대한 기준치를 적용할 수도 있습니다.
    

# Ref

프록시 : https://woo-chang.tistory.com/28

연관관계 주인 : https://hoestory.tistory.com/28

N+1 문제 : https://programmer93.tistory.com/83, https://dev-coco.tistory.com/165#head1

영속성전이, 고아객체 : [https://wale.tistory.com/entry/JPA-영속성-전이CASCADE와-고아-객체](https://wale.tistory.com/entry/JPA-%EC%98%81%EC%86%8D%EC%84%B1-%EC%A0%84%EC%9D%B4CASCADE%EC%99%80-%EA%B3%A0%EC%95%84-%EA%B0%9D%EC%B2%B4)

TDD, DDD : [https://velog.io/@sinclebear/TDD-BDD-DDD란](https://velog.io/@sinclebear/TDD-BDD-DDD%EB%9E%80)

Junit 4,5 : https://kkh1902.tistory.com/191

단위,통합,인수 테스트 : [https://velog.io/@rladmlduq47/단위-테스트-통합-테스트-시스템-테스트-인수테스트-차이](https://velog.io/@rladmlduq47/%EB%8B%A8%EC%9C%84-%ED%85%8C%EC%8A%A4%ED%8A%B8-%ED%86%B5%ED%95%A9-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8B%9C%EC%8A%A4%ED%85%9C-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%9D%B8%EC%88%98%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%B0%A8%EC%9D%B4)
계층별 테스트 : https://caffeineoverflow.tistory.com/143
stub, mock : [https://velog.io/@goseungwon/Test-Stub과-Mock의-차이점](https://velog.io/@goseungwon/Test-Stub%EA%B3%BC-Mock%EC%9D%98-%EC%B0%A8%EC%9D%B4%EC%A0%90)

Controller test : https://velog.io/@gale4739/Spring-Boot-Controller-test-with-JUnit5
